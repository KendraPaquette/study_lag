{
  "hash": "e1a2e8baf49feb1856ce05e0346a2698",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Supplemental Material\"\nsubtitle: \"Lagged Predictions of Next Week Alcohol Use for Precision Mental Health Support\"\nauthor: \"Kendra Wyant, Gaylen E. Fronk, Jiachen Yu, and John J. Curtin\"\ndate: last-modified\nnumber-sections: true\nformat: \n  html: \n    embed-resources: true\n    toc: true \n    toc_depth: 5\neditor_options: \n  chunk_output_type: console\n---\n\n\n\nThis file contains the supplemental materials for *Lagged Predictions of Next Week Alcohol Use for Precision Mental Health Support*. It includes a transparency report and all supplemental figures and tables. Additional materials are made available on our study's OSF page ([https://osf.io/xta67/](https://osf.io/xta67/)).   \n\n-----\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nsuppressPackageStartupMessages(library(tidyverse))\nsuppressPackageStartupMessages(source(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\"))\nsuppressPackageStartupMessages(library(tidyposterior))\n\n\ntheme_set(theme_classic())\n\noptions(knitr.kable.NA = '')\n\npath_models_lag <- format_path(str_c(\"studydata/risk/models/lag\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\npp_tidy <- read_csv(here::here(path_models_lag, \"pp_tidy.csv\"), \n                                 show_col_types = FALSE) \n\nci <- read_csv(here::here(path_models_lag, \"test_metrics_all_pp_perf.csv\"), \n                                 show_col_types = FALSE) |> \n  mutate(model = factor(model, levels = c(\"0 lag\", \"24 lag\", \"72 lag\", \"168 lag\", \"336 lag\"),\n                        labels = c(\"0 hours\", \"24 hours\", \"72 hours\", \"168 hours\", \"336 hours\")))\n\npp_dem <- read_csv(here::here(path_models_lag, \"pp_dem_all.csv\"), \n                                 show_col_types = FALSE)\n```\n:::\n\n\n\n## Transparency Report 1.0 (full, 36 items; Aczel et al., 2019)\n\n**Manuscript Title:** Lagged Predictions of Next Week Alcohol Use for Precision Mental Health Support   \n**Authors:** Kendra Wyant, Gaylen E. Fronk, Jiachen Yu, and John J. Curtin   \n**Corresponding author’s email address:** jjcurtin@wisc.edu   \n**Link to Project Repository:** [https://osf.io/xta67/](https://osf.io/xta67/)      \n\n### Preregistration Section   \n- Prior to analyzing the complete data set, a time-stamped preregistration was posted in an independent, third-party registry for the data analysis plan: Yes  \n\nComments about your Preregistration: We pre-registered our data analytic strategy on OSF.   \n\n### Methods Section\nThe manuscript fully describes…    \n\n- the rationale for the sample size used (e.g., an a priori power analysis): Yes  \n- how participants were recruited: Yes  \n- how participants were selected (e.g., eligibility criteria): Yes  \n- what compensation was offered for participation: Yes  \n- how participant dropout was handled (e.g., replaced, omitted, etc): Yes  \n- how participants were assigned to conditions: N/A.  There are no conditions.  \n- how stimulus materials were randomized: N/A.    \n- whether (and, if so, how) participants, experimenters, and data-analysts were kept naive to potentially biasing information: N/A.  This is an observations study that does not include analysis of group or manipulations.   There were no study conditions to blind.   \n- the study design, procedures, and materials to allow independent replication: Yes   \n-\tthe measures of interest (e.g., friendliness): Yes   \n-\tall operationalizations for the measures of interest (e.g., a questionnaire measuring friendliness): Yes   \n\n### Results and Discussion Section\nThe manuscript…  \n\n-\tdistinguishes explicitly between “confirmatory” (i.e., prespecified) and “exploratory” (i.e., not prespecified) analyses: All analyses were pre-registered.\n-\tdescribes how violations of statistical assumptions were handled: No  \n-\tjustifies all statistical choices (e.g., including or excluding covariates; applying or not applying transformations; use of multi-level models vs. ANOVA): Yes  \n-\treports the sample size for each cell of the design: Yes  \n-\treports how incomplete or missing data were handled: Yes  \n-\tpresents protocols for data preprocessing (e.g., cleaning, discarding of cases and items, normalizing, smoothing, artifact correction): Yes  \n\n### Data, Code, and Materials Availability Section\nThe following have been made publicly available…  \n\n-\tthe (processed) data, on which the analyses of the manuscript were based: Yes   \n-\tall code and software (that is not copyright protected): Yes   \n-\tall instructions, stimuli, and test materials (that are not copyright protected): Yes   \n-\tAre the data properly archived (i.e., would a graduate student with relevant background knowledge be able to identify each variable and reproduce the analysis): Yes   \n-\tThe manuscript includes a statement concerning the availability and location of all research items, including data, materials, and code relevant to the study: Yes   \n\n\n\\newpage\n\n## Supplemental Methods\n\n### Feature Importance\n\nWe calculated Shapley values in log-odds units for binary classification models from the 30 test sets to provide a description of the importance of categories of features across our five models [@lundbergUnifiedApproachInterpreting2017]. We averaged the three Shapley values for each observation for each feature (i.e., across the three repeats) to increase their stability. An inherent property of Shapley values is their additivity, allowing us to combine features into feature categories. We created separate feature categories for each of the nine EMA questions, the rates of past alcohol use and missing surveys, the time of day and day of the week of the start of the prediction window, and the seven demographic variables included in the models. We calculated the local (i.e., for each observation) importance for each category of features by adding Shapley values across all features in a category, separately for each observation. We calculated global importance for each feature category by averaging the absolute value of the Shapley values of all features in the category across all observations. These local and global importance scores based on Shapley values allow us to contextualize relative feature importance for each model.\n\n## Supplemental Results\n\n### Feature Importance\n\nThe top three globally important (i.e., highest mean |Shapley value|) feature categories for all models were past use, future efficacy, and craving (Figure S2). Future risky situations were also globally important across models. This category was ranked as the 4th most important feature across lagged models (24, 72, 168, and 336 hours). For the immediate model (0 hour lag), past risky situations were ranked as the 4th most important feature category and future risky situations was ranked as the fifth most important. Income was the only demographic feature that emerged as having high global importance for lapse prediction (in top 6 for all models). See Table S1 for a table of feature categories ranked by global importance for each model.    \n\nSee Figure S3 for a local feature importance plots for each model. Future abstinence efficacy, future risky situations, and income appear to have a linear relationship to lapse prediction. Higher efficacy, fewer future risky situations, and higher income were associated with a lower likelihood that the model would predict a lapse. In Figure S4, we plot the relationship between Shapley value and feature score individually for our overall top five features by model.\n\n\n## Supplemental Figures\n\n### Figure S1: Full Posterior Distributions for auROC by Model\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\npp_tidy |> \n  mutate(model = factor(model, levels = c(\"lag0\", \"lag24\", \"lag72\", \"lag168\", \"lag336\"),\n                        labels = c(\"0 hours\", \"24 hours\", \"72 hours\", \"168 hours\", \"336 hours\"))) |>\n  ggplot() + \n  geom_histogram(aes(x = posterior), fill = \"light grey\", color = \"black\", alpha = .4, \n                 bins = 30) +\n  geom_segment(mapping = aes(y = 1200, yend = 1600, x = pp_median, xend = pp_median),\n               data = ci) +\n  geom_segment(mapping = aes(y = 1400, yend = 1400, x = pp_lower, xend = pp_upper),\n                data = ci) +\n  facet_wrap(~model, ncol = 1) +\n  scale_y_continuous(\"Posterior Probability\", breaks = c(0, 500, 1000, 1500)) +\n  xlab(\"Area Under ROC Curve\") +\n  theme_classic() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n### Figure S2: Global Shapley Plot\n\n\nRead in data\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_all <- read_rds(here::here(path_models_lag, \"shap_global_all.rds\")) |> \n   filter(!variable_grp %in% c(\"day of week (other)\", \"time of day (other)\")) |> \n  mutate(variable_grp = str_remove(variable_grp, \"(EMA item)\"),\n          variable_grp = str_remove(variable_grp, \"(demographic)\"),\n          variable_grp = str_remove(variable_grp, \"(other)\"),\n        variable_grp = str_remove(variable_grp, \"[[:punct:]][[:punct:]]\")) |> \n   mutate(variable_grp = reorder(variable_grp, mean_value, sum),\n          model = factor(model, c(\"0 lag\", \"24 lag\", \"72 lag\", \"168 lag\", \"336 lag\")))\n\nshap_levels <- global_all |>\n  mutate(variable_grp = reorder(variable_grp, mean_value, sum)) |>\n  pull(variable_grp) |>\n  levels()\n```\n:::\n\n\n\n\nGlobal shapley pannel\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ncolor_codes <- c(\"#240e31\",\"#75f3d3\", \"#458892\", \"#751c6d\", \"#cb6bce\")\n\npanel_shap_global <- global_all |>\n   mutate(model = factor(model, levels = c(\"336 lag\", \"168 lag\", \"72 lag\", \"24 lag\", \"0 lag\" ),\n                         labels = c(\"336 hours\", \"168 hours\", \"72 hours\", \"24 hours\", \"0 hours\" ))) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, fill = model), stat = \"identity\") +\n  ylab(\"Mean(|Shapley Value|)\") +\n  xlab(\"\") +\n  labs(fill = \"Model Lag\") +\n  scale_color_manual(values = color_codes) +\n  scale_fill_manual(values = color_codes) +\n  theme(axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1),\n        legend.position = \"right\",\n        # legend.key.size = unit(.3, 'cm'),\n        ) +\n  coord_flip()\n```\n:::\n\n::: {#cell-fig-shap .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shap\n#| fig-cap: \"Global importance (mean |Shapley value|) for feature categories for each model. Feature categories are ordered by their aggregate global importance (i.e., total bar length) across the five models. The importance of each feature category for specific models is displayed separately by color.\"\n#| fig-height: 5.5\n#| fig-width: 7\n\npanel_shap_global\n```\n\n::: {.cell-output-display}\n![Global importance (mean |Shapley value|) for feature categories for each model. Feature categories are ordered by their aggregate global importance (i.e., total bar length) across the five models. The importance of each feature category for specific models is displayed separately by color.](supplement_files/figure-html/fig-shap-1.png){#fig-shap width=672}\n:::\n:::\n\n\n\n\n### Figure S3: Local Shapley Plots by Model\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_0 <- read_rds(here::here(path_models_lag, \"outer_shapsgrp_with_features_downsized_1week_0_v1_nested_main.rds\")) |> \n  mutate(variable_grp = factor(variable_grp, levels = shap_levels),\n         feature_score_z_mean = if_else(variable_grp == \"future efficacy \",\n                                        feature_score_z_mean * (-1),\n                                        feature_score_z_mean))\n  \nshap_feat_24 <- read_rds(here::here(path_models_lag, \"outer_shapsgrp_with_features_downsized_1week_24_v1_nested_main.rds\")) |> \n  mutate(variable_grp = factor(variable_grp, levels = shap_levels),\n         feature_score_z_mean = if_else(variable_grp == \"future efficacy \",\n                                        feature_score_z_mean * -1,\n                                        feature_score_z_mean))\n\nshap_feat_72 <- read_rds(here::here(path_models_lag, \"outer_shapsgrp_with_features_downsized_1week_72_v1_nested_main.rds\")) |> \n  mutate(variable_grp = factor(variable_grp, levels = shap_levels),\n         feature_score_z_mean = if_else(variable_grp == \"future efficacy \",\n                                        feature_score_z_mean * -1,\n                                        feature_score_z_mean))\nshap_feat_168 <- read_rds(here::here(path_models_lag, \"outer_shapsgrp_with_features_downsized_1week_168_v1_nested_main.rds\")) |> \n  mutate(variable_grp = factor(variable_grp, levels = shap_levels),\n         feature_score_z_mean = if_else(variable_grp == \"future efficacy \",\n                                        feature_score_z_mean * -1,\n                                        feature_score_z_mean))\n\nshap_feat_336 <- read_rds(here::here(path_models_lag, \"outer_shapsgrp_with_features_downsized_1week_336_v1_nested_main.rds\")) |> \n  mutate(variable_grp = factor(variable_grp, levels = shap_levels),\n         feature_score_z_mean = if_else(variable_grp == \"future efficacy \",\n                                        feature_score_z_mean * -1,\n                                        feature_score_z_mean))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\npanel_shap_local_0 <- shap_feat_0 |>\n  filter(!is.na(variable_grp)) |> \n  # scale feat score to 0-1\n  mutate(feature_score = (feature_score_z_mean - min(feature_score_z_mean))/(max(feature_score_z_mean)-min(feature_score_z_mean))) |> \n  ggplot(mapping = aes(x = variable_grp, y = value, color = feature_score)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = .7, alpha = .4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-2, 5), breaks = seq(-2, 5)) +\n  ylab(\"Shapley Value (0 Hour Lag)\") +\n  xlab(NULL) +\n  scale_color_gradientn(colors = c(\"#240e31\", \"#cb6bce\"),\n                        breaks = c(.1, .9),\n                        labels = c(\"low\", \"high\")) +\n  labs(color = NULL) +\n  theme(legend.position = \"right\",\n        legend.key.size = unit(0.25, \"cm\"),\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))+\n  coord_flip()\n\npanel_shap_local_24 <- shap_feat_24 |>\n  filter(!is.na(variable_grp)) |> \n  # scale feat score to 0-1\n  mutate(feature_score = (feature_score_z_mean - min(feature_score_z_mean))/(max(feature_score_z_mean)-min(feature_score_z_mean))) |> \n  ggplot(mapping = aes(x = variable_grp, y = value, color = feature_score)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = .7, alpha = .4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-2, 5), breaks = seq(-2, 5)) +\n  ylab(\"Shapley Value (24 Hour Lag)\") +\n  xlab(NULL) +\n  scale_color_gradientn(colors = c(\"#240e31\", \"#922488\"),\n                        breaks = c(.1, .9),\n                        labels = c(\"low\", \"high\")) +\n  labs(color = NULL) +\n  theme(legend.position = \"right\",\n        legend.key.size = unit(0.25, \"cm\"),\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))+\n  coord_flip()\n\npanel_shap_local_72 <- shap_feat_72 |>\n  filter(!is.na(variable_grp)) |> \n  # scale feat score to 0-1\n  mutate(feature_score = (feature_score_z_mean - min(feature_score_z_mean))/(max(feature_score_z_mean)-min(feature_score_z_mean))) |> \n  ggplot(mapping = aes(x = variable_grp, y = value, color = feature_score)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = .7, alpha = .4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-2, 5), breaks = seq(-2, 5)) +\n  ylab(\"Shapley Value (72 Hour Lag)\") +\n  xlab(NULL) +\n  scale_color_gradientn(colors = c(\"#240e31\", \"#458892\"),\n                        breaks = c(.1, .9),\n                        labels = c(\"low\", \"high\")) +\n  labs(color = NULL) +\n  theme(legend.position = \"right\",\n        legend.key.size = unit(0.25, \"cm\"),\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))+\n  coord_flip()\n\npanel_shap_local_168 <- shap_feat_168 |>\n  filter(!is.na(variable_grp)) |> \n  # scale feat score to 0-1\n  mutate(feature_score = (feature_score_z_mean - min(feature_score_z_mean))/(max(feature_score_z_mean)-min(feature_score_z_mean))) |> \n  ggplot(mapping = aes(x = variable_grp, y = value, color = feature_score)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = .7, alpha = .4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-2, 5), breaks = seq(-2, 5)) +\n  ylab(\"Shapley Value (168 Hour Lag)\") +\n  xlab(NULL) +\n  scale_color_gradientn(colors = c(\"#240e31\", \"#75f3d3\"),\n                        breaks = c(.1, .9),\n                        labels = c(\"low\", \"high\")) +\n  labs(color = NULL) +\n  theme(legend.position = \"right\",\n        legend.key.size = unit(0.25, \"cm\"),\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))+\n  coord_flip()\n\n\npanel_shap_local_336 <- shap_feat_336 |>\n  filter(!is.na(variable_grp)) |> \n  # scale feat score to 0-1\n  mutate(feature_score = (feature_score_z_mean - min(feature_score_z_mean))/(max(feature_score_z_mean)-min(feature_score_z_mean))) |> \n  ggplot(mapping = aes(x = variable_grp, y = value, color = feature_score)) +\n  ggforce::geom_sina(method = \"counts\", maxwidth = .7, alpha = .4) +\n  geom_hline(yintercept = 0) +\n  scale_y_continuous(limits = c(-2, 5), breaks = seq(-2, 5)) +\n  ylab(\"Shapley Value (336 Hour Lag)\") +\n  xlab(NULL) +\n  scale_color_gradientn(colors = c(\"#240e31\", \"#f9e79f\"),\n                        breaks = c(.1, .9),\n                        labels = c(\"low\", \"high\")) +\n  labs(color = NULL) +\n  theme(legend.position = \"right\",\n        legend.key.size = unit(0.25, \"cm\"),\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))+\n  coord_flip()\n```\n:::\n\n::: {#cell-fig-shap-local .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-shap-local\n#| fig-cap: \"Local feature importance plots by model.\"\n#| fig-height: 8\n#| fig-width: 10\n\ncowplot::plot_grid(panel_shap_local_0,\n                   panel_shap_local_24,\n                   panel_shap_local_72, \n                   panel_shap_local_168,\n                   panel_shap_local_336, \n                   ncol = 2, labels = c(\"A\", \"B\", \"C\", \"D\", \"E\"), \n                   align = \"hv\")\n```\n\n::: {.cell-output-display}\n![Local feature importance plots by model.](supplement_files/figure-html/fig-shap-local-1.png){#fig-shap-local width=960}\n:::\n:::\n\n\n\n\n### Figure S4: Individual Shapley Plots for Top Features\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_all <- shap_feat_0 |> \n  mutate(model = \"0 hours\") |> \n  rbind(shap_feat_24 |> \n  mutate(model = \"24 hours\")) |> \n  rbind(shap_feat_72 |> \n  mutate(model = \"72 hours\")) |> \n  rbind(shap_feat_168 |> \n  mutate(model = \"168 hours\")) |> \n  rbind(shap_feat_336 |> \n  mutate(model = \"336 hours\")) |> \n  mutate(model = factor(model, levels = c(\"0 hours\", \"24 hours\", \"72 hours\",\n                                          \"168 hours\", \"336 hours\")))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\ncolor_codes <- c(\"#cb6bce\", \"#751c6d\", \"#458892\", \"#75f3d3\", \"#240e31\")\n\nshap_feat_all |> \n  filter(variable_grp == \"past use \") |> \n  ggplot(aes(x = feature_score_z_mean, y = value, color = model)) +\n  geom_point(alpha = .4) +\n  geom_smooth(formula = y ~ x, \n              method = \"loess\", color = \"black\", linewidth = .75) +\n  facet_wrap(~model) +\n  scale_color_manual(values = color_codes) +\n  labs(title = \"Past Use\", y = \"Shapley\", x = \"Feature value\") +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_all |> \n  filter(variable_grp == \"future efficacy \") |> \n  ggplot(aes(x = feature_score_z_mean, y = value, color = model)) +\n  geom_point(alpha = .4) +\n  geom_smooth(formula = y ~ x, \n              method = \"loess\", color = \"black\", linewidth = .75) +\n  facet_wrap(~model) +\n  scale_color_manual(values = color_codes) +\n  labs(title = \"Future Efficacy\", y = \"Shapley\", x = \"Feature value\") +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_all |> \n  filter(variable_grp == \"income \") |> \n  ggplot(aes(x = feature_score_z_mean, y = value, color = model)) +\n  geom_point(alpha = .4) +\n  geom_smooth(formula = y ~ x, \n              method = \"loess\", color = \"black\", linewidth = .75) +\n  facet_wrap(~model) +\n  scale_color_manual(values = color_codes) +\n  labs(title = \"Income\", y = \"Shapley\", x = \"Feature value\") +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-11-3.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_all |> \n  filter(variable_grp == \"craving \") |> \n  ggplot(aes(x = feature_score_z_mean, y = value, color = model)) +\n  geom_point(alpha = .4) +\n  geom_smooth(formula = y ~ x, \n              method = \"loess\", color = \"black\", linewidth = .75) +\n  facet_wrap(~model) +\n  scale_color_manual(values = color_codes) +\n  labs(title = \"Craving\", y = \"Shapley\", x = \"Feature value\") +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-11-4.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\n\nshap_feat_all |> \n  filter(variable_grp == \"future risky situation \") |> \n  ggplot(aes(x = feature_score_z_mean, y = value, color = model)) +\n  geom_point(alpha = .4) +\n  geom_smooth(formula = y ~ x, \n              method = \"loess\", color = \"black\", linewidth = .75) +\n  facet_wrap(~model) +\n  scale_color_manual(values = color_codes) +\n  labs(title = \"Future Risky Situation\", y = \"Shapley\", x = \"Feature value\") +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1))\n```\n\n::: {.cell-output-display}\n![](supplement_files/figure-html/unnamed-chunk-11-5.png){width=672}\n:::\n:::\n\n\n\n\n\n## Supplemental Tables\n\n### Table S1: Global Shapley Scores by Model\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_all |> \n  arrange(model, desc(mean_value)) |> \n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|model   |variable_grp           | mean_value|\n|:-------|:----------------------|----------:|\n|0 lag   |past use               |  0.6915530|\n|0 lag   |future efficacy        |  0.3354062|\n|0 lag   |craving                |  0.1492141|\n|0 lag   |past risky situation   |  0.0409319|\n|0 lag   |future risky situation |  0.0396250|\n|0 lag   |income                 |  0.0386680|\n|0 lag   |past stressful event   |  0.0347977|\n|0 lag   |past pleasant event    |  0.0303134|\n|0 lag   |future stressful event |  0.0235291|\n|0 lag   |valence                |  0.0180646|\n|0 lag   |arousal                |  0.0153398|\n|0 lag   |missing surveys        |  0.0104797|\n|0 lag   |age                    |  0.0056648|\n|0 lag   |sex                    |  0.0036376|\n|0 lag   |employment             |  0.0020814|\n|0 lag   |education              |  0.0015701|\n|0 lag   |marital                |  0.0012997|\n|0 lag   |race                   |  0.0003310|\n|24 lag  |past use               |  0.6353110|\n|24 lag  |future efficacy        |  0.3225067|\n|24 lag  |craving                |  0.1349103|\n|24 lag  |future risky situation |  0.0422645|\n|24 lag  |past risky situation   |  0.0316897|\n|24 lag  |income                 |  0.0314424|\n|24 lag  |past stressful event   |  0.0228529|\n|24 lag  |valence                |  0.0221616|\n|24 lag  |past pleasant event    |  0.0215528|\n|24 lag  |future stressful event |  0.0151652|\n|24 lag  |arousal                |  0.0092257|\n|24 lag  |missing surveys        |  0.0042630|\n|24 lag  |sex                    |  0.0035956|\n|24 lag  |age                    |  0.0026348|\n|24 lag  |employment             |  0.0023221|\n|24 lag  |marital                |  0.0010465|\n|24 lag  |education              |  0.0005360|\n|24 lag  |race                   |  0.0003213|\n|72 lag  |past use               |  0.5259043|\n|72 lag  |future efficacy        |  0.2500811|\n|72 lag  |craving                |  0.1072869|\n|72 lag  |future risky situation |  0.0430571|\n|72 lag  |past risky situation   |  0.0391228|\n|72 lag  |income                 |  0.0284529|\n|72 lag  |valence                |  0.0242838|\n|72 lag  |past pleasant event    |  0.0205197|\n|72 lag  |future stressful event |  0.0199576|\n|72 lag  |past stressful event   |  0.0190108|\n|72 lag  |missing surveys        |  0.0164443|\n|72 lag  |arousal                |  0.0087430|\n|72 lag  |sex                    |  0.0059852|\n|72 lag  |age                    |  0.0048634|\n|72 lag  |employment             |  0.0029590|\n|72 lag  |marital                |  0.0020081|\n|72 lag  |education              |  0.0008448|\n|72 lag  |race                   |  0.0008334|\n|168 lag |past use               |  0.7202721|\n|168 lag |future efficacy        |  0.2708614|\n|168 lag |craving                |  0.1853099|\n|168 lag |future risky situation |  0.0673724|\n|168 lag |income                 |  0.0615443|\n|168 lag |valence                |  0.0472200|\n|168 lag |past risky situation   |  0.0456872|\n|168 lag |past pleasant event    |  0.0422742|\n|168 lag |past stressful event   |  0.0396944|\n|168 lag |future stressful event |  0.0268345|\n|168 lag |missing surveys        |  0.0172899|\n|168 lag |arousal                |  0.0160417|\n|168 lag |sex                    |  0.0109266|\n|168 lag |age                    |  0.0060001|\n|168 lag |employment             |  0.0032052|\n|168 lag |marital                |  0.0027324|\n|168 lag |education              |  0.0004615|\n|168 lag |race                   |  0.0003573|\n|336 lag |past use               |  0.5669742|\n|336 lag |future efficacy        |  0.1799614|\n|336 lag |craving                |  0.1343185|\n|336 lag |future risky situation |  0.1078876|\n|336 lag |past pleasant event    |  0.0653338|\n|336 lag |income                 |  0.0564261|\n|336 lag |valence                |  0.0451530|\n|336 lag |past risky situation   |  0.0398233|\n|336 lag |past stressful event   |  0.0366207|\n|336 lag |arousal                |  0.0355294|\n|336 lag |future stressful event |  0.0319974|\n|336 lag |age                    |  0.0143800|\n|336 lag |missing surveys        |  0.0097757|\n|336 lag |sex                    |  0.0052177|\n|336 lag |employment             |  0.0024394|\n|336 lag |marital                |  0.0015635|\n|336 lag |education              |  0.0015587|\n|336 lag |race                   |  0.0001792|\n\n\n:::\n:::\n\n\n\n### Table S2: Model performance by Demographic Group\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n\npp_dem <- pp_dem |> \n  mutate(lag = factor(lag, levels = c(0, 24, 72, 168, 336), \n                        labels = c(\"0 hours\", \"24 hours\", \"72 hours\", \"168 hours\", \"336 hours\" )),\n         model = factor(model, levels = c(\"not white\", \"non-hispanic white\",\n                                        \"female\", \"male\",\n                                        \"below poverty\", \"above poverty\"))) |> \n  arrange(model, lag)\n\npp_dem_all <- pp_dem |> \n  filter(lag == \"0 hours\") |> \n  mutate(pp_lower = round(pp_lower, 3),\n         pp_upper = round(pp_upper, 3),\n         ci = str_c(pp_lower,\"-\",pp_upper)) |>\n  select(-c(lag, pp_lower, pp_upper)) |> \n  bind_cols(pp_dem |> \n  filter(lag == \"24 hours\") |> \n  mutate(pp_lower = round(pp_lower, 3),\n         pp_upper = round(pp_upper, 3),\n         ci = str_c(pp_lower,\"-\",pp_upper)) |>\n  select(-c(lag, pp_lower, pp_upper, model))) |> \n  bind_cols(pp_dem |> \n  filter(lag == \"72 hours\") |> \n  mutate(pp_lower = round(pp_lower, 3),\n         pp_upper = round(pp_upper, 3),\n         ci = str_c(pp_lower,\"-\",pp_upper)) |>\n  select(-c(lag, pp_lower, pp_upper, model))) |> \n  bind_cols(pp_dem |> \n  filter(lag == \"168 hours\") |> \n  mutate(pp_lower = round(pp_lower, 3),\n         pp_upper = round(pp_upper, 3),\n         ci = str_c(pp_lower,\"-\",pp_upper)) |>\n  select(-c(lag, pp_lower, pp_upper, model))) |> \n  bind_cols(pp_dem |> \n  filter(lag == \"336 hours\") |> \n  mutate(pp_lower = round(pp_lower, 3),\n         pp_upper = round(pp_upper, 3),\n         ci = str_c(pp_lower,\"-\",pp_upper)) |>\n  select(-c(lag, pp_lower, pp_upper, model))) |> \n  add_row(model = \"Race/Ethnicity\", .before = 1) |> \n  add_row(model = \"Sex at Birth\", .before = 4) |> \n  add_row(model = \"Income\", .before = 7) |> \n  suppressMessages()\n```\n:::\n\n::: {#tbl-fairness .cell tbl-cap='Model Performance by Demographic Group'}\n\n```{.r .cell-code .hidden}\n#| label: tbl-fairness\n#| tbl-cap: \"Model Performance by Demographic Group\"\n\npp_dem_all |> \n  mutate(across(c(pp_median...2, pp_median...4, pp_median...6, pp_median...8, pp_median...10), \n                ~round(., 3)),\n         across(where(is.numeric), as.character)) |> \n  add_row(model = \"Group\",\n          pp_median...2 = \"Median auROC\",\n          ci...3 = \"Bayesian CI\",\n          pp_median...4 = \"Median auROC\",\n          ci...5 = \"Bayesian CI\",\n          pp_median...6 = \"Median auROC\",\n          ci...7 = \"Bayesian CI\",\n          pp_median...8 = \"Median auROC\",\n          ci...9 = \"Bayesian CI\",\n          pp_median...10 = \"Median auROC\",\n          ci...11 = \"Bayesian CI\",\n          .before = 1) |> \n  knitr::kable(col.names = c(\"\", \"0 Lag\", \"\",\n                    \"24 Lag\", \"\", \n                   \"72 Lag\", \"\",\n                    \"168 Lag\", \"\",\n                   \"336 Lag\", \"\")) \n```\n\n::: {.cell-output-display}\n\n\n|                   |0 Lag        |            |24 Lag       |            |72 Lag       |            |168 Lag      |            |336 Lag      |            |\n|:------------------|:------------|:-----------|:------------|:-----------|:------------|:-----------|:------------|:-----------|:------------|:-----------|\n|Group              |Median auROC |Bayesian CI |Median auROC |Bayesian CI |Median auROC |Bayesian CI |Median auROC |Bayesian CI |Median auROC |Bayesian CI |\n|Race/Ethnicity     |             |            |             |            |             |            |             |            |             |            |\n|not white          |0.736        |0.622-0.822 |0.713        |0.58-0.815  |0.727        |0.644-0.792 |0.733        |0.668-0.786 |0.749        |0.691-0.802 |\n|non-hispanic white |0.905        |0.857-0.938 |0.894        |0.829-0.938 |0.886        |0.843-0.918 |0.881        |0.847-0.908 |0.857        |0.819-0.888 |\n|Sex at Birth       |             |            |             |            |             |            |             |            |             |            |\n|female             |0.867        |0.847-0.885 |0.849        |0.827-0.869 |0.836        |0.813-0.856 |0.823        |0.801-0.845 |0.788        |0.76-0.815  |\n|male               |0.926        |0.914-0.936 |0.921        |0.908-0.932 |0.916        |0.903-0.927 |0.92         |0.907-0.93  |0.905        |0.89-0.918  |\n|Income             |             |            |             |            |             |            |             |            |             |            |\n|below poverty      |0.812        |0.757-0.856 |0.805        |0.759-0.843 |0.792        |0.744-0.834 |0.749        |0.7-0.794   |0.729        |0.68-0.77   |\n|above poverty      |0.903        |0.874-0.926 |0.892        |0.864-0.913 |0.884        |0.856-0.908 |0.882        |0.856-0.904 |0.86         |0.831-0.884 |\n\n\n:::\n:::\n",
    "supporting": [
      "supplement_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}