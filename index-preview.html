<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  lang="en"
  xml:lang="en"
  >
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="quarto-1.5.45" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

    <meta name="author" content="Kendra Wyant" />
    <meta name="author" content="Gaylen E. Fronk" />
    <meta name="author" content="Jiachen Yu" />
    <meta name="author" content="John J. Curtin" />
    <meta name="dcterms.date" content="2024-10-23" />
    <meta name="keywords" content="Substance use disorders, Precision mental health" />

    <title>Lagged Predictions of Next Week Alcohol Use for Precision Mental Health Support</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      /* CSS for citations */
      div.csl-bib-body { }
      div.csl-entry {
        clear: both;
        margin-bottom: 0em;
      }
      .hanging-indent div.csl-entry {
        margin-left:2em;
        text-indent:-2em;
      }
      div.csl-left-margin {
        min-width:2em;
        float:left;
      }
      div.csl-right-inline {
        margin-left:2em;
        padding-left:1em;
      }
      div.csl-indent {
        margin-left: 2em;
      }    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    <!-- htmldependencies:E3FAD763 -->
     
      </head>

  <body>
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link"><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Article Notebook</h6>

            <a
        href="index.qmd"
        class="btn btn-primary quarto-download-embed"
        data-noresolveinput="true"
        download="index.qmd"
        >Download Source</a
      >
          </div>

     <div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <div id="quarto-toc-target"></div>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">      <header id="title-block-header" class="quarto-title-block default toc-left">
  <div class="quarto-title-banner">
    <div class="quarto-title column-body">
      <h1 class="title">Lagged Predictions of Next Week Alcohol Use for Precision Mental Health Support</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Authors</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Kendra Wyant </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Department of Psychology, University of Wisconsin-Madison
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Gaylen E. Fronk </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Department of Psychology, University of Wisconsin-Madison
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">Jiachen Yu </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Department of Psychology, University of Wisconsin-Madison
                      </p>
                  </div>
                      <div class="quarto-title-meta-contents">
            <p class="author">John J. Curtin <a href="mailto:jjcurtin@wisc.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Department of Psychology, University of Wisconsin-Madison
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">October 23, 2024</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>

    <div>
      <div class="abstract">
        <div class="block-title">Abstract</div>
        <p>We evaluated the performance of a model predicting immediate alcohol lapses and models with increasing lag time between the prediction time points and start of the prediction window (24, 72, 168, or 336 hour lag). Model features were engineered from 4x daily ecological momentary assessment. Participants (N =151; 51% male; mean age= 41; 87% White, 97% Non-Hispanic) were in early recovery from alcohol use disorder and provided data for up to three months. We used nested cross-validation to select and evaluate the best models. Median auROCs were high across models (range = 0.85 – 0.89). All lagged models performed significantly worse than the 0 lag model (probabilities &gt; .95). Comparisons between adjacent lags revealed significant differences between 24 and 72 hour lag models and 168 and 336 hour lag models. All models performed significantly worse for minority groups (not White vs. non-Hispanic White, below poverty vs. above poverty, female vs. male).</p>
      </div>
    </div>

    <div>
      <div class="keywords">
        <div class="block-title">Keywords</div>
        <p>Substance use disorders, Precision mental health</p>
      </div>
    </div>

    <div class="quarto-other-links-text-target">
    </div>  </div>
</header>

     <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction">Introduction</a></li>
  <li><a href="#methods" id="toc-methods">Methods</a>
  <ul>
  <li><a href="#transparency-and-openness" id="toc-transparency-and-openness">Transparency and Openness</a></li>
  <li><a href="#participants" id="toc-participants">Participants</a></li>
  <li><a href="#procedure" id="toc-procedure">Procedure</a></li>
  <li><a href="#measures" id="toc-measures">Measures</a>
  <ul>
  <li><a href="#ecological-momentary-assessments" id="toc-ecological-momentary-assessments">Ecological Momentary Assessments</a></li>
  <li><a href="#individual-characteristics" id="toc-individual-characteristics">Individual Characteristics</a></li>
  </ul></li>
  <li><a href="#data-analytic-strategy" id="toc-data-analytic-strategy">Data Analytic Strategy</a>
  <ul>
  <li><a href="#predictions" id="toc-predictions">Predictions</a></li>
  <li><a href="#labels" id="toc-labels">Labels</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering">Feature Engineering</a></li>
  <li><a href="#model-training-and-evaluation" id="toc-model-training-and-evaluation">Model Training and Evaluation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#results" id="toc-results">Results</a>
  <ul>
  <li><a href="#demographic-and-lapse-characteristics" id="toc-demographic-and-lapse-characteristics">Demographic and Lapse Characteristics</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation">Model Evaluation</a></li>
  <li><a href="#model-comparisons" id="toc-model-comparisons">Model Comparisons</a>
  <ul>
  <li><a href="#baseline-contrasts" id="toc-baseline-contrasts">Baseline Contrasts</a></li>
  <li><a href="#adjacent-contrasts" id="toc-adjacent-contrasts">Adjacent Contrasts</a></li>
  </ul></li>
  <li><a href="#fairness-analyses-1" id="toc-fairness-analyses-1">Fairness Analyses</a></li>
  <li><a href="#feature-importance-1" id="toc-feature-importance-1">Feature Importance</a></li>
  <li><a href="#discussion" id="toc-discussion">Discussion</a></li>
  <li><a href="#model-performance" id="toc-model-performance">Model Performance</a></li>
  <li><a href="#model-fairness" id="toc-model-fairness">Model Fairness</a></li>
  <li><a href="#additional-limitations-and-future-directions" id="toc-additional-limitations-and-future-directions">Additional Limitations and Future Directions</a></li>
  <li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references">References</a></li>
  </ul></li>
  </ul>
</nav>  <!-- 9/20/24 - At 6,532 words.-->
<!--Notes:
Target journal: Clinical Psychological Science 
Format: Brief empirical report (5,000 words)

Brief Empirical Reports. Brief empirical reports will have a 5,000-word limit, inclusive of front (title page) and back matter (references, footnotes). Articles are limited to a total combination of 4 tables and figures (e.g., 2 tables and 2 figures) that are not part of the word limit. Each table or figure should occupy no more than one printed page. An abstract (maximum of 150 words) is included in the word limit.-->
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(tidyverse))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">source</span>(<span class="st">&quot;https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true&quot;</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(tidyposterior))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra, <span class="at">exclude =</span> <span class="st">&quot;group_rows&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>path_models_lag <span class="ot">&lt;-</span> <span class="fu">format_path</span>(<span class="fu">str_c</span>(<span class="st">&quot;studydata/risk/models/lag&quot;</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>path_processed <span class="ot">&lt;-</span> <span class="fu">format_path</span>(<span class="st">&quot;studydata/risk/data_processed/lag&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.kable.NA =</span> <span class="st">&#39;&#39;</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in tibbles for in-line code</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>test_metrics_all_perf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;test_metrics_all.csv&quot;</span>), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>test_metrics_all_pp_perf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;test_metrics_all_pp_perf.csv&quot;</span>), </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>ci_baseline <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;ci_baseline.csv&quot;</span>), </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>ci_lag <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;ci_lag.csv&quot;</span>), <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>pp_dem <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;pp_dem_all.csv&quot;</span>), <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>pp_dem_contrast <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_models_lag, <span class="st">&quot;pp_dem_contrast_all.csv&quot;</span>), <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>screen <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_processed, <span class="st">&quot;dem_tibble.csv&quot;</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>lapses_per_subid <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(path_processed, <span class="st">&quot;lapse_tibble.csv&quot;</span>),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                             <span class="at">col_types =</span> <span class="fu">cols</span>())</span></code></pre></div>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Precision medicine has been a goal in healthcare for over half a century <span class="citation" data-cites="derubeisHistoryCurrentStatus2019">(<a href="#ref-derubeisHistoryCurrentStatus2019" role="doc-biblioref">DeRubeis 2019</a>)</span>. Traditionally, precision medicine seeks to answer the question of <em>how</em> we best treat a specific individual, given their unique combination of genetic, lifestyle, and environmental characteristics (e.g., which medication is most effective for whom).</p>
<p>Today, this approach is also applied to chronic mental health conditions (i.e., precision mental health) such as depression, substance use disorders, and suicide. Mental health conditions are complex, fluctuating processes. Medical conditions often have clear biological precursors, which may be treated well with a single medication. In contrast, mental health conditions are products of numerous psychosocial factors, and treatments must be selected from a wide array of supports. Moreover, the factors driving mental health conditions differ between individuals and can change within an individual over time. Thus, precision mental health must consider both the <em>how</em> and the <em>when</em> (e.g., which treatment is most effective for whom at what moment).</p>
<!-- not sure people will know what low dimensional is without some explanation. This problem is probably not just that the models were low dimensional but that they focused on individual characteristics rather than a large set of characteristics.  And the models werent set up to handle non-linear and interactive effects.   RE static distal features, maybe it better to think of these as demographics and baseline characteristics.  that will  help with later issue regarding lagged models.   --->
<p>There has been long-standing interest in precision mental health and substance use disorders. An early example is the Project MATCH research group, which attempted to match individuals with alcohol use disorder to their optimal treatment based on baseline measures of individual characteristics <span class="citation" data-cites="projectmatchresearchgroupMatchingAlcoholismTreatments1997">(<a href="#ref-projectmatchresearchgroupMatchingAlcoholismTreatments1997" role="doc-biblioref">Project Match Research Group 1997</a>)</span>. Earlier studies, however, have been constrained to 1) low-dimensional analyses that fail to capture the complex and heterogeneous nature of substance use disorders and 2) the use of static distal features to predict a non-linear, time-varying course of recovery, lapse, and relapse <span class="citation" data-cites="witkiewitzModelingComplexityPosttreatment2007">(<a href="#ref-witkiewitzModelingComplexityPosttreatment2007" role="doc-biblioref">Witkiewitz and Marlatt 2007</a>)</span>.</p>
<!-- ML can also handle interactive and non-linear effects-->
<p>Recent advances in both machine learning and personal sensing may address these barriers to successful precision mental health. Machine learning uses high dimensional inputs that can capture the complexity of mental health conditions. Moreover, tools from machine learning can be applied to models to understand which factors are important to a specific individual at a specific moment in time, addressing the question of <em>how</em>.</p>
<!--combining two unrelated ideas below - importance of longitudingal sensing and why we focus on lapse.  Do in different paragraphs?-->
<p>Personal sensing allows for frequent, longitudinal measurement of changes in proximal risk (e.g., for a lapse) with high temporal precision, for better understanding the <em>when</em>. This precision is particularly important for predicting discrete symptoms or behaviors. Take the example of lapses, discrete instances of goal inconsistent substance use. Lapses are a clinically important target for substance use treatment. They are often an early warning sign of relapse, and maladaptive responses to lapses can undermine recovery. For some substances, even a single lapse can result in an overdose and/or death. It would be unreasonable to expect that we could predict a lapse with any temporal precision using only features that become more distal as time progresses. Rather, lapse prediction requires dense, long-term monitoring of symptoms and related states proximal to the outcome. &lt;!– you say distal will be a problem but isnt that what we are trying to do in this paper? Maybe better to say not reasonable to expect stable demographics and/or baseline characteristics to predict well over time– &gt;</p>
<!--this should be linked to the sensing paragraph above once you break them apart.  Right now, the lapse info sits in the middle-->
<p>Ecological momentary assessment (EMA) may be particularly well-suited for risk prediction algorithms. It offers momentary subjective insight into constructs that can be easily mapped onto modular forms of treatment, such as the relapse prevention model <span class="citation" data-cites="marlattRelapsePreventionMaintenance1985 witkiewitzRelapsePreventionAlcohol2004">(<a href="#ref-marlattRelapsePreventionMaintenance1985" role="doc-biblioref">Marlatt and Gordon 1985</a>; <a href="#ref-witkiewitzRelapsePreventionAlcohol2004" role="doc-biblioref">Witkiewitz and Marlatt 2004</a>)</span>. EMA also appears to be well tolerated by individuals with substance use disorders <span class="citation" data-cites="wyantAcceptabilityPersonalSensing2023">(<a href="#ref-wyantAcceptabilityPersonalSensing2023" role="doc-biblioref">Wyant et al. 2023</a>)</span>. Thus, it can serve as an important signal for predicting substance use outcomes and interpreting clinically relevant features over a sustained period. <!--Can also cite RISK2 protocol paper to say people are doing it up to a year--></p>
<!--people are going to need a bit more detail about your ema paper.  Later you talk about hour, day, week but its not clear what several different prediction widths mean here-->
<p>Promising preliminary work suggests it is possible to build EMA models that predict immediate lapses back to substance use <span class="citation" data-cites="waltersUsingMachineLearning2021 baeMobilePhoneSensors2018 soysterPooledPersonspecificMachine2022 chihPredictiveModelingAddiction2014">(<a href="#ref-waltersUsingMachineLearning2021" role="doc-biblioref">Walters et al. 2021</a>; <a href="#ref-baeMobilePhoneSensors2018" role="doc-biblioref">Bae et al. 2018</a>; <a href="#ref-soysterPooledPersonspecificMachine2022" role="doc-biblioref">Soyster, Ashlock, and Fisher 2022</a>; <a href="#ref-chihPredictiveModelingAddiction2014" role="doc-biblioref">Chih et al. 2014</a>)</span>. In a previous study from our group, we demonstrated that we can do this very well <span class="citation" data-cites="wyantMachineLearningModels2023">(<a href="#ref-wyantMachineLearningModels2023" role="doc-biblioref">Wyant et al. 2024</a>)</span>. We used 4X daily EMA with questions designed to measure theoretically-implicated risk factors including past use, craving, past pleasant events, past and future risky situations, past and future stressful events, emotional valence and arousal, and self-efficacy. We showed that it was possible to predict immediate alcohol lapses for several different prediction widths with clinically meaningful accuracy. <!--  reader will need more help to understand that the EMA paper predicted lapses in the NEXT hour, etc.   So you can contrast that better with lagged models here--></p>
<!-- I think we should move away from the idea of JIT.  Lets talk more about why and how to finesse this and what to call it-->
<p>Narrow prediction window widths (i.e., next hour or next day) without any lag time between the prediction time point and start of the prediction window are well-suited for <em>Just-in-Time</em> interventions that make algorithm-guided recommendations to address immediate risks - for example, recommending a coping with craving activity when someone has increased craving, or recommending a guided relaxation video when someone is reporting recent stressful events. Importantly, these supports can be available 24/7 (e.g., in a digital therapeutic) for an individual, allowing them to take action right away.</p>
<p>However, many interventions cannot be self-contained in a digital therapeutic and take time to set up. For example, someone who has reported recent past alcohol use and low abstinence self-efficacy might be encouraged to attend a self-help meeting, plan an outing with important people in their life, or schedule an appointment with a therapist. These multimodal interventions (i.e., combined human and digital interventions) are not available 24/7. A <em>time-lagged</em> model where prediction windows are shifted further into the future (i.e., away from the prediction time point) could provide patients with increased lead time to implement supports that might not be immediately available to them. In these situations, a wider prediction window width (i.e, one week) may be preferred. Wider window widths yield higher proportions of positive labels mitigating issues of an unbalanced outcome. Additionally, when scheduling real world support, it is important that the lead up time is adequate and not that the prediction is necessarily temporally precise.</p>
<p>In this study, we evaluated the performance of a model predicting immediate next week lapses compared to models using increased lag time between the prediction time points and the start of the prediction window. Specifically, we used the same EMA features as our immediate model and trained new models to predict the probability of a lapse beginning one day (24 hours), three days (72 hours), one week (168 hours), or two weeks (336 hours) into the future. We evaluated each lagged model to determine if they perform at clinically implementable levels and assessed the relative difference in performance as lag time increased.</p>
<!-- not sure that responsible and transparent reporting makes me think of fairness.  Sounds more like open science, data sharing, etc.  Can instead just say its important to look beyond overall model performance to subgroups to make sure models are fair and wont increase exisiting disparites-->
<p>Additionally, our group is committed to the responsible and transparent reporting of model performance. Models that work for only a subset of people, if implemented, could widen existing treatment disparities. Therefore we reported our models’ performance for three dichotomized demographic groups with known disparities in access to substance use treatment - race and ethnicity (not White vs. non-Hispanic White) <span class="citation" data-cites="pinedoCurrentReexaminationRacial2019 kilaruIncidenceTreatmentOpioid2020">(<a href="#ref-pinedoCurrentReexaminationRacial2019" role="doc-biblioref">Pinedo 2019</a>; <a href="#ref-kilaruIncidenceTreatmentOpioid2020" role="doc-biblioref">Kilaru et al. 2020</a>)</span>, income (below poverty vs. above poverty) <span class="citation" data-cites="olfsonHealthcareCoverageService2022">(<a href="#ref-olfsonHealthcareCoverageService2022" role="doc-biblioref">Olfson et al. 2022</a>)</span>, and sex at birth (female vs. male) <span class="citation" data-cites="greenfieldSubstanceAbuseTreatment2007 kilaruIncidenceTreatmentOpioid2020">(<a href="#ref-greenfieldSubstanceAbuseTreatment2007" role="doc-biblioref">Greenfield et al. 2007</a>; <a href="#ref-kilaruIncidenceTreatmentOpioid2020" role="doc-biblioref">Kilaru et al. 2020</a>)</span>.</p>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="transparency-and-openness" class="level2">
<h2>Transparency and Openness</h2>
<p>We adhere to research transparency principles that are crucial for robust and replicable science. We preregistered our data analytic strategy. We reported how we determined the sample size, all data exclusions, all manipulations, and all study measures. We provide a transparency report in the supplement. Finally, our data, analysis scripts, annotated results, questionnaires, and other study materials are publicly available (<a href="https://osf.io/xta67/">https://osf.io/xta67/</a>).</p>
</section>
<section id="participants" class="level2">
<h2>Participants</h2>
<p>We recruited participants in early recovery (1-8 weeks of abstinence) from moderate to severe alcohol use disorder in Madison, Wisconsin, US for a three month longitudinal study. One hundred fifty one participants were included in our analyses. We used data from all participants included in our previous study (see <span class="citation" data-cites="wyantMachineLearningModels2023">(<a href="#ref-wyantMachineLearningModels2023" role="doc-biblioref">Wyant et al. 2024</a>)</span> for enrollment and disposition information). This sample size was determined based on traditional power analysis methods for logistic regression <span class="citation" data-cites="hsiehSampleSizeTables1989">(<a href="#ref-hsiehSampleSizeTables1989" role="doc-biblioref">Hsieh 1989</a>)</span> because comparable approaches for machine learning models have not yet been validated. Participants were recruited through print and targeted digital advertisements and partnerships with treatment centers. We required that participants:</p>
<ol type="1">
<li>were age 18 or older,</li>
<li>could write and read in English,</li>
<li>had at least moderate AUD (&gt;= 4 self-reported DSM-5 symptoms),</li>
<li>were abstinent from alcohol for 1-8 weeks, and</li>
<li>were willing to use a single smartphone (personal or study provided) while on study.</li>
</ol>
<p>We also excluded participants exhibiting severe symptoms of psychosis or paranoia.</p>
</section>
<section id="procedure" class="level2">
<h2>Procedure</h2>
<p>Participants completed five study visits over approximately three months. After an initial phone screen, participants attended an in-person screening visit to determine eligibility, complete informed consent, and collect self-report measures. Eligible, consented participants returned approximately one week later for an intake visit. Three additional follow-up visits occurred about every 30 days that participants remained on study. Participants were expected to complete four daily EMAs while on study. Other personal sensing data streams (geolocation, cellular communications, sleep quality, and audio check-ins) were collected as part of the parent grant’s aims (R01 AA024391). Participants could earn up to $150/month if they completed all study visits, had 10% or less missing EMA data and opted in to provide data for other personal sensing data streams.</p>
</section>
<section id="measures" class="level2">
<h2>Measures</h2>
<section id="ecological-momentary-assessments" class="level3">
<h3>Ecological Momentary Assessments</h3>
<p>Participants completed four brief (7-10 questions) EMAs daily. The first and last EMAs of the day were scheduled within one hour of participants’ typical wake and sleep times. The other two EMAs were scheduled randomly within the first and second halves of their typical day, with at least one hour between EMAs. Participants learned how to complete the EMA and the meaning of each question during their intake visit.</p>
<p>On all EMAs, participants reported dates/times of any unreported past alcohol use. Next, participants rated the maximum intensity of recent (i.e., since last EMA) experiences of craving, risky situations, stressful events, and pleasant events. Finally, participants rated their current affect on two bipolar scales: valence (Unpleasant/Unhappy to Pleasant/Happy) and arousal (Calm/Sleepy to Aroused/Alert).</p>
<p>On the first EMA each day, participants also rated the likelihood of encountering risky situations and stressful events in the next week and the likelihood that they would drink alcohol in the next week (i.e., abstinence self-efficacy).</p>
</section>
<section id="individual-characteristics" class="level3">
<h3>Individual Characteristics</h3>
<p>We collected self-report information about demographics (age, sex, race, ethnicity, education, marital status, employment, and income) and AUD symptom count to characterize our sample. Demographic information was also included as features in our models and a subset (sex, race, ethnicity, and income) used for model fairness analyses.</p>
<p>As part of the aims of the parent project we collected many other trait and state measures throughout the study. A complete list of all measures can be found on our study’s OSF page.</p>
</section>
</section>
<section id="data-analytic-strategy" class="level2">
<h2>Data Analytic Strategy</h2>
<p>Data preprocessing, modeling, and Bayesian analyses were done in R using the tidymodels ecosystem <span class="citation" data-cites="kuhnTidymodelsCollectionPackages2020 kuhnTidyposteriorBayesianAnalysis2022 goodrichRstanarmBayesianApplied2023">(<a href="#ref-kuhnTidymodelsCollectionPackages2020" role="doc-biblioref">Kuhn and Wickham 2020</a>; <a href="#ref-kuhnTidyposteriorBayesianAnalysis2022" role="doc-biblioref">Kuhn 2022</a>; <a href="#ref-goodrichRstanarmBayesianApplied2023" role="doc-biblioref">Goodrich et al. 2023</a>)</span>. Models were trained and evaluated using high-throughput computing resources provided by the University of Wisconsin Center for High Throughput Computing <span class="citation" data-cites="chtc">(<a href="#ref-chtc" role="doc-biblioref">Center for High Throughput Computing 2006</a>)</span>.</p>
<section id="predictions" class="level3">
<h3>Predictions</h3>
<p><a href="#fig-methods" class="quarto-xref">Figure 1</a> shows how we established prediction time points, windows, and lags. All available data up until, but not including, the prediction time point was used to generate model predictions. Prediction time points were updated hourly (Panel A). The first prediction time point for each participant was 24 hours from midnight on their study start date. This ensured at least 24 hours of past EMAs for future lapse prediction at these first time points. Subsequent predictions time points for each participant repeatedly rolled hour-by-hour until the end of their study participation.</p>
<p>The prediction window width was one week. Prediction windows rolled forward hour-by-hour with the prediction time point (Panel B). There were five possible lag times between the prediction time point and start of the prediction window. A prediction window either started immediately after the prediction time point (0 lag) or was lagged by 24, 72, 168, or 336 hours.</p>
<p>Therefore, our models provided hour-by-hour probabilities of an alcohol lapse in the next week pushed out up to two weeks into the future.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\kpaquette2\study_lag\notebooks\mak_figures.qmd" data-notebook-title="Make All Figures for Main Manuscript" data-notebook-cellId="cell-fig-methods">
<div id="cell-fig-methods" class="cell">
<div class="sourceCode" id="cb3"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>knitr::include_graphics(path <span class="op">=</span> here::here(<span class="st">&quot;figures/methods.png&quot;</span>), error <span class="op">=</span> FALSE)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-methods" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-methods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/notebooks-mak_figures-fig-methods-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure 1: We used all available data up until the prediction timepoint to generate features using varying scoring epochs. Prediction timepoints rolled forward hour-by-hour (Panel A). Prediction windows were 1 week wide. A prediction window started immediately after the prediction timepoint (0 lag) or was lagged by 24, 72, 168, or 336 hours (Panel B)."><img src="index_files/figure-html/notebooks-mak_figures-fig-methods-output-1.png" class="img-fluid" /></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-methods-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: We used all available data up until the prediction timepoint to generate features using varying scoring epochs. Prediction timepoints rolled forward hour-by-hour (Panel A). Prediction windows were 1 week wide. A prediction window started immediately after the prediction timepoint (0 lag) or was lagged by 24, 72, 168, or 336 hours (Panel B).
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="labels" class="level3">
<h3>Labels</h3>
<p>The start and end date/time of past drinking episodes were reported on the first EMA item. A prediction window was labeled <em>lapse</em> if the start date/hour of any drinking episode fell within that window. A window was labeled <em>no lapse</em> if no alcohol use occurred within that window +/- 24 hours. If no alcohol use occurred within the window but did occur within 24 hours of the start or end of the window, the window was excluded.</p>
<p>We ended up with a total of 270,081 labels for our baseline (no lag) model, 266,599 labels for our 24 hour lagged model, 259,643 labels for our 72 hour lagged model, 245,707 labels for our 168 hour lagged model, and 221,206 labels for our 336 hour lagged model.</p>
</section>
<section id="feature-engineering" class="level3">
<h3>Feature Engineering</h3>
<p>Features were calculated using only data collected before the start of each prediction window to ensure our models were making true future predictions. For our no lag models this included all data prior to the hour of the start of the prediction window. For our lagged models, the last EMA data used for feature engineering were collected up to 24 hours, 72 hours, 168 hours, or 336 hours prior to the start of the prediction window.</p>
<p>A total of 279 features were derived from two data sources:</p>
<ol type="1">
<li><p><em>Demographics</em>: We created quantitative features for age and personal income, and dummy-coded features for sex, race/ethnicity, marital status, education, and employment.</p></li>
<li><p><em>Previous EMA responses</em>: We created raw EMA and change features for varying scoring epochs (i.e., 12, 24, 48, 72, and 168 hours) before the start of the prediction window for all EMA items. Raw features included min, max, and median scores for each EMA item across all EMAs in each epoch for that participant. We calculated change features by subtracting the participants’ overall mean score for each EMA item (using all EMAs collected before the start of the prediction window) from the associated raw feature. We also created raw and change features based on the most recent response for each EMA question and raw and change rate features from previously reported lapses and number of completed EMAs.</p></li>
</ol>
<p>Other generic feature engineering steps included imputing missing data (median imputation for numeric features, mode imputation for nominal features) and removing zero and near-zero variance features as determined from held-in data (see Cross-validation section below).</p>
</section>
<section id="model-training-and-evaluation" class="level3">
<h3>Model Training and Evaluation</h3>
<section id="model-configurations" class="level4">
<h4>Model Configurations</h4>
<p>We trained and evaluated five separate classification models: one baseline (no lag) model and one model for 24 hour, 72 hour, 168 hour, and 336 hour lagged predictions. We considered four well-established statistical algorithms (elastic net, XGBoost, regularized discriminant analysis, and single layer neural networks) that vary across characteristics expected to affect model performance (e.g., flexibility, complexity, handling higher-order interactions natively) <span class="citation" data-cites="kuhnAppliedPredictiveModeling2018">(<a href="#ref-kuhnAppliedPredictiveModeling2018" role="doc-biblioref">Kuhn and Johnson 2018</a>)</span>.</p>
<p>Candidate model configurations differed across sensible values for key hyperparameters. They also differed on outcome resampling method (i.e., no resampling and up-sampling and down-sampling of the outcome using majority/no lapse to minority/lapse ratios ranging from 1:1 to 2:1). We calibrated predicted probabilities using the beta distribution to support optimal decision-making under variable outcome distributions <span class="citation" data-cites="kullSigmoidsHowObtain2017">(<a href="#ref-kullSigmoidsHowObtain2017" role="doc-biblioref">Kull, Filho, and Flach 2017</a>)</span>.</p>
</section>
<section id="cross-validation" class="level4">
<h4>Cross-validation</h4>
<p>We used participant-grouped, nested cross-validation for model training, selection, and evaluation with auROC. auROC indexes the probability that the model will predict a higher score for a randomly selected positive case (lapse) relative to a randomly selected negative case (no lapse). Grouped cross-validation assigns all data from a participant as either held-in or held-out to avoid bias introduced when predicting a participant’s data from their own data. We used 1 repeat of 10-fold cross-validation for the inner loops (i.e., <em>validation</em> sets) and 3 repeats of 10-fold cross-validation for the outer loop (i.e., <em>test</em> sets). Best model configurations were selected using median auROC across the 10 validation sets. Final performance evaluation of those best model configurations used median auROC across the 30 test sets.</p>
</section>
<section id="bayesian-model" class="level4">
<h4>Bayesian Model</h4>
<p>We used a Bayesian hierarchical generalized linear model to estimate the posterior probability distributions and 95% Bayesian credible intervals (CIs) from the 30 held-out test sets for our five best models. Following recommendations from the rstanarm team and others <span class="citation" data-cites="rstudioteamRStudioIntegratedDevelopment2020 gabryPriorDistributionsRstanarm2023">(<a href="#ref-rstudioteamRStudioIntegratedDevelopment2020" role="doc-biblioref">RStudio Team 2020</a>; <a href="#ref-gabryPriorDistributionsRstanarm2023" role="doc-biblioref">Gabry and Goodrich 2023</a>)</span>, we used the rstanarm default autoscaled, weakly informative, data-dependent priors that take into account the order of magnitude of the variables to provide some regularization to stabilize computation and avoid over-fitting.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> We set two random intercepts to account for our resampling method: one for the repeat, and another for the fold nested within repeat. We specified two sets of contrasts for model comparisons. The first set compared each lagged model to the baseline model (0 lag vs. 24 hour lag, 0 lag vs. 72 hour lag, 0 lag vs. 168 lag, 0 lag vs. 336 lag). The second set compared adjacently lagged models (24 hour lag vs. 72 hour lag, 72 hour lag vs. 168 hour lag, 168 hour lag vs. 336 hour lag). auROCs were transformed using the logit function and regressed as a function of model contrast.</p>
<p>From the Bayesian model we obtained the posterior distribution (transformed back from logit) and Bayeisan CIs for all five models. To evaluate our models’ overall performance we report the median posterior probability for auROC and Bayesian CIs. This represents our best estimate for the magnitude of the auROC parameter for each model. If the confidence intervals do not contain .5 (chance performance), this suggests our model is capturing signal in the data.</p>
<p>We then conducted Bayesian model comparisons using our two sets of contrasts - baseline and adjacent lags. For both model comparisons, we determined the probability that the models’ performances differed systematically from each other. We also report the precise posterior probability for the difference in auROCs and the 95% Bayesian CIs. If there was a probability &gt;.95 that the more lagged model’s performance was worse, we labeled the model contrast as significant.</p>
</section>
<section id="fairness-analyses" class="level4">
<h4>Fairness Analyses</h4>
<p>We calculated the median posterior probability and 95% Bayesian CI for auROC for each model separately by race and ethnicity (not White vs. non-Hispanic White), income (below poverty vs. above poverty<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>), and sex at birth (female vs. male). We conducted Bayesian group comparisons to assess the likelihood that each model performs differently by group. We report the median difference and range in posterior probabilities across all models. The median auROC and Bayesian CIs are reported separately by group and model in the supplement.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
</section>
<section id="feature-importance" class="level4">
<h4>Feature Importance</h4>
<p>We calculated Shapley values in log-odds units for binary classification models from the 30 test sets to provide a description of the importance of categories of features across our five models <span class="citation" data-cites="lundbergUnifiedApproachInterpreting2017">(<a href="#ref-lundbergUnifiedApproachInterpreting2017" role="doc-biblioref">Lundberg and Lee 2017</a>)</span>. We averaged the three Shapley values for each observation for each feature (i.e., across the three repeats) to increase their stability. An inherent property of Shapley values is their additivity, allowing us to combine features into feature categories. We created separate feature categories for each of the nine EMA questions, the rates of past alcohol use and missing surveys, the time of day and day of the week of the start of the prediction window, and the seven demographic variables included in the models. We calculated the local (i.e., for each observation) importance for each category of features by adding Shapley values across all features in a category, separately for each observation. We calculated global importance for each feature category by averaging the absolute value of the Shapley values of all features in the category across all observations. These local and global importance scores based on Shapley values allow us to contextualize relative feature importance for each model.</p>
</section>
</section>
</section>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<section id="demographic-and-lapse-characteristics" class="level2">
<h2>Demographic and Lapse Characteristics</h2>
<!-- GEF: if needed for space, you could just refer to the table here rather than duplicating in-text -->
<p>There were approximately equal numbers of men (N=77; 51.0%) and women (N=74; 49.0%) who ranged in age from 21 - 72 years old. The sample was majority White (N=131; 86.8%) and non-Hispanic (N=147; 97.4%). Participants self-reported a median of 9.0 DSM-5 symptoms of AUD and most participants (N=84; 55.6%) reported one or more lapses during participation. <a href="#tbl-demohtml" class="quarto-xref">Table 1</a> provides more detail on demographic and lapse characteristics of the sample.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\kpaquette2\study_lag\notebooks\mak_tables.qmd" data-notebook-title="Make All Tables for Main Manuscript" data-notebook-cellId="cell-tbl-demohtml">
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>table_dem <span class="op">|&gt;</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  knitr::kable()</span></code></pre></div>
<div id="tbl-demohtml" class="cell quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-demohtml-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 1: Demographic and Lapse Characteristics
</figcaption>
<div aria-describedby="tbl-demohtml-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown">
<table class="do-not-create-environment cell caption-top" style="width:98%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 6%" />
<col style="width: 7%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">var</th>
<th style="text-align: right;">N</th>
<th style="text-align: right;">%</th>
<th style="text-align: left;">M</th>
<th style="text-align: left;">SD</th>
<th style="text-align: left;">Range</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Age</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;">41</td>
<td style="text-align: left;">11.9</td>
<td style="text-align: left;">21-72</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sex</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Female</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">49.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Male</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">51.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Race</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">American Indian/Alaska Native</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Asian</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Black/African American</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">5.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">White/Caucasian</td>
<td style="text-align: right;">131</td>
<td style="text-align: right;">86.8</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Other/Multiracial</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hispanic, Latino, or Spanish origin</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">2.6</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">147</td>
<td style="text-align: right;">97.4</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Education</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Less than high school or GED degree</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">High school or GED</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">9.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Some college</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">27.2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">2-Year degree</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">9.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">College degree</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">38.4</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Advanced degree</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">15.2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Employment</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Employed full-time</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">47.7</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Employed part-time</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">17.2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Full-time student</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Homemaker</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.7</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Disabled</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">4.6</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Retired</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">5.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Unemployed</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">11.9</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Temporarily laid off, sick leave, or maternity leave</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Other, not otherwise specified</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">6.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Personal Income</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;">$34,298</td>
<td style="text-align: left;">$31,807</td>
<td style="text-align: left;">$0-200,000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Marital Status</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Never married</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">44.4</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Married</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">21.2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Divorced</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">29.8</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Separated</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Widowed</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.3</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">DSM-5 AUD Symptom Count</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;">8.9</td>
<td style="text-align: left;">1.9</td>
<td style="text-align: left;">4-11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Reported 1 or More Lapse During Study Period</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">55.6</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">44.4</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of reported lapses</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: left;">6.8</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">0-75</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="model-evaluation" class="level2">
<h2>Model Evaluation</h2>
<p>The median auROC across the 30 test sets for our baseline model was high (median=0.893, IQR=0.045), consistent with our previous study.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Performance across our lagged models was also high for the 24 hour lag (median=0.882, IQR=0.039), 72 hour lag (median=0.868, IQR=0.057), 168 hour lag (median=0.860, IQR=0.062), and 336 hour lag (median=0.856, IQR=0.062).</p>
<p>Histograms of the full posterior probability distributions for auROC for each model are available in the supplement. The median auROCs from these posterior distributions were 0.893 (baseline), 0.887 (24 hour lag), 0.875 (72 hour lag), 0.871 (168 hour lag), and 0.852 (336 hour lag). These values represent our best estimates for the magnitude of the auROC parameter for each model. The 95% Bayesian CI for the auROCs for these models were relatively narrow and did not contain 0.5: baseline [0.876-0.908], 24 hour lag [0.869-0.903], 72 hour lag [0.855-0.892], 168 hour lag [0.850-0.889], 336 hour lag [0.830-0.872]. Panel A in <a href="#fig-1" class="quarto-xref">Figure 2</a> displays these median auROCs and 95% Bayesian CIs by model.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\kpaquette2\study_lag\notebooks\mak_figures.qmd" data-notebook-title="Make All Figures for Main Manuscript" data-notebook-cellId="cell-fig-1">
<div id="cell-fig-1" class="cell" data-fig-width="7">
<div class="sourceCode" id="cb5"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fig_1</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-1" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/notebooks-mak_figures-fig-1-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure 2: Median posterior probability for area under ROC curve (auROC) and Bayesian credible interval by model. Dashed line represents a random classifier."><img src="index_files/figure-html/notebooks-mak_figures-fig-1-output-1.png" width="672" height="480" /></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 2: Median posterior probability for area under ROC curve (auROC) and Bayesian credible interval by model. Dashed line represents a random classifier.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="model-comparisons" class="level2">
<h2>Model Comparisons</h2>
<section id="baseline-contrasts" class="level3">
<h3>Baseline Contrasts</h3>
<p>The median decrease in auROC for the baseline vs. 24 hour lag model was 0.006 (95% CI=[0.000-0.012]), yielding a significant probability of 0.960 that the lagged model had worse performance. The median decrease in auROC for the baseline vs. 72 hour model was 0.018 (95% CI=[0.012-0.025]), yielding a significant probability of 1.000 that the lagged model had worse performance. The median decrease in auROC for the baseline vs. 168 hour lag model was 0.023 (95% CI=[0.016-0.029]), yielding a significant probability of 1.000 that the lagged model had worse performance. The median decrease in auROC for the baseline vs. 336 hour lag model was 0.041 (95% CI=[0.033-0.049]), yielding a significant probability of 1.000 that the lagged model had worse performance.</p>
</section>
<section id="adjacent-contrasts" class="level3">
<h3>Adjacent Contrasts</h3>
<p>The median decrease in auROC for the 24 hour vs. 72 hour lag model was 0.012 (95% CI=[0.006-0.019]), yielding a significant probability of 1.000 that the 72 hour lag model had worse performance than the 24 hour lag model. The median decrease in auROC for the 72 hour vs. 168 hour lag model was 0.004 (95% CI=[-0.002-0.011]), yielding a non-significant probability of 0.865 that the 168 hour lag model had worse performance than the 72 hour lag model. The median decrease in auROC for the 168 hour vs. 336 hour lag model was 0.018 (95% CI=[0.011-0.025]), yielding a significant probability of 1.000 that the 336 hour lag model had worse performance than the 168 hour lag model.</p>
</section>
</section>
<section id="fairness-analyses-1" class="level2">
<h2>Fairness Analyses</h2>
<p><a href="#fig-2" class="quarto-xref">Figure 3</a> shows the median auROC and credible intervals for each model separately by race (not White; <em>N</em> = 20 vs. Non-Hispanic White; <em>N</em> = 131), sex at birth (female; <em>N</em> = 74 vs. Male; <em>N</em> = 77), and income (below poverty; <em>N</em> = 18 vs. above poverty; <em>N</em> = 133). All group comparisons were significant (probability &gt; .95) across models. On average there was a median decrease in auROC of 0.159 (range 0.107-0.179) for participants who were not White compared to non-Hispanic White participants. On average there was a median decrease in auROC of 0.080 (range 0.059-0.116) for female participants compared to male participants. On average there was a median decrease in auROC of 0.092 (range 0.086-0.133) for participants below the federal poverty line compared to participants above the federal poverty line.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\kpaquette2\study_lag\notebooks\mak_figures.qmd" data-notebook-title="Make All Figures for Main Manuscript" data-notebook-cellId="cell-fig-2">
<div id="cell-fig-2" class="cell" data-fig-width="8" data-fig-height="6">
<div class="sourceCode" id="cb6"><pre class="sourceCode python cell-code"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>pp_dem_a <span class="op">+</span> pp_dem_b <span class="op">+</span> pp_dem_c <span class="op">+</span> plot_layout(guides <span class="op">=</span> <span class="st">&quot;collect&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  theme(legend.position <span class="op">=</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">&amp;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  plot_annotation(tag_levels <span class="op">=</span> <span class="st">&quot;A&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-2" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/notebooks-mak_figures-fig-2-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure 3: Median posterior probability for area under ROC curve (auROC) and Bayesian credible interval by model and fairness contrast Dashed line represents a random classifier."><img src="index_files/figure-html/notebooks-mak_figures-fig-2-output-1.png" width="768" height="576" /></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 3: Median posterior probability for area under ROC curve (auROC) and Bayesian credible interval by model and fairness contrast Dashed line represents a random classifier.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="feature-importance-1" class="level2">
<h2>Feature Importance</h2>
<p>The top three globally important (i.e., highest mean |Shapley value|) feature categories for all models were past use, future efficacy, and craving. Future risky situations were also globally important across models. This category was ranked as the 4th most important feature across lagged models (24, 72, 168, and 336 hours). For the immediate model (0 hour lag), past risky situations were ranked as the 4th most important feature category and future risky situations was ranked as the fifth most important. Income was the only demographic feature that emerged as having high global importance for lapse prediction (in top 6 for all models). In the supplement we provide a plot of global importance by model and a table of feature categories ranked by global importance for each model.</p>
<p>Local feature importance plots for each model can be found in the supplement. Future abstinence efficacy, future risky situations, and income appear to have a linear relationship to lapse prediction. Higher efficacy, fewer future risky situations, and higher income were associated with a lower likelihood that the model would predict a lapse. In the supplement, we plot the relationship between Shapley value and feature score individually for our overall top five features by model.</p>
</section>
<section id="discussion" class="level2">
<h2>Discussion</h2>
</section>
<section id="model-performance" class="level2">
<h2>Model Performance</h2>
<p>Our models performed exceptionally well with median posterior probabilities for auROCs of .85 - .89. This suggests we can achieve clinically meaningful performance up to two weeks out. Our rigorous resampling methods (grouped, nested, k-fold cross-validation) make us confident that these are valid estimates of how our models would perform with new individuals.</p>
<!-- there is a bit of a tension in your explanation suggesting that features for fluctuatinng processes may not predict as well into the future.  They work well in a next week model which IS into the future, right?-->
<!-- not sure what you mean by missing some of these features and using lagged models to supplement.  Seems like we are using these lagged models for a different goal - distal prediction needed for future planning.   Not sure that these lagged models only "supplement" for that goal given that the next windows dont tell us about the future-->
<p>Nevertheless, model performance did significantly decrease as models predicted further into the future. This is unsurprising given what we know about prediction and substance use. First, as lag time increases, features become less proximal to the prediction time point. Many important relapse risk factors are fluctuating processes that can change day-by-day, if not more frequently. For example, cravings can come on quickly (e.g., after encountering a person or place that reminds them of their use) and typically only last for up to 30 minutes. It may be acceptable to miss some of these more dynamic risk factors, however, if we consider lagged models as a supplement to immediate lapse prediction models (i.e., models with no lag). Lagged prediction models are most useful for their ability to provide individuals with advance notice that they may be at risk for lapsing. This advance notice can be used to implement more time-intensive recovery supports, such as attending a support group. On the other hand, an immediate lapse prediction model (i.e., no lag) is well-suited for detecting immediate risk and making a recommendation just-in-time (e.g., pointing to an activity available 24/7 on the web).</p>
<!-- not sure this is "mixed evidence"   That ususally means some support and some lack of support.  I think you are suggesting just different patterns for different classes of feautres?-->
<!-- i agree that its work unpacking the future risk is current risk in the future idea-->
<p>We saw mixed evidence that feature importance might change depending on lag. Past use and craving were the top two features for all models. This suggests that although these features can change quickly, they are important enough to consistently emerge as top predictors regardless of lag time. Recent past risky situations, however, ranked high for the immediate prediction models, but future anticipated risky situations was relatively more important for the lagged models. <!-- GEF: Maybe not necessary to note, but my reaction to this is that future anticipated risky situations for long-lag models essentially become recent risky situations (relative to the prediction outcome). Like, if someone says they are likely to experience a risky situation in the next week, and then that does happen, 1 week from now they will endorse having a recent risky situation! Anyway, not sure if this detail is needed, but I think it raises sort of an exciting idea of the potential added utility of future-facing questions for lagged models! --> <!--KW: Yes! I like the idea to expand on this with a sentence or two. Just not sure yet how to phrase it yet.--></p>
<!-- this next paragraph wont be clear to most readers.  Needs more explanation.   -->
<p>Second, participants only provided EMA for up to three months. Therefore, a lag time of two weeks between the prediction time point and start of the prediction window prohibits us from using 1/6th of the EMA data for predictions. It is possible that this loss of data contributed to decreased performance in the lagged models. In a separate NIH protocol underway, participants are providing EMA and other sensed data for up to 12 months <span class="citation" data-cites="moshontzProspectivePredictionLapses2021">(<a href="#ref-moshontzProspectivePredictionLapses2021" role="doc-biblioref">Moshontz et al. 2021</a>)</span>. By comparing models built from these two datasets, we will better be able to evaluate whether this loss of data impacted model performance and if we can sustain similar performance with even longer lags in these data. Still, we wish to emphasize that our lowest auROC (.85) is still excellent, and the benefit of advanced notice likely outweighs the cost to performance.</p>
</section>
<section id="model-fairness" class="level2">
<h2>Model Fairness</h2>
<!-- lead with the racial/ethinc issue that has the simple explanation (lack of diversity in training data).  Then observe that there were problems with fairness even for subgroups were well-represented.  Do that in a separate paragraph to help separate the points.-->
<p>All models performed worse for women, for people who were not White, and for people who had an income below the poverty line. The largest contributing factor is likely the lack of diversity in our training data. For example, even with our coarse combination of race/ethnicity, the not White group was largely underrepresented relative to the non-Hispanic White group. The best solution to this limitation would be to recruit a more representative sample. However, there may be methods to mitigate these issues in the current data. We could explore upsampling minority group representation in the data (e.g., using synthetic minority oversampling technique). We also could adjust the penalty weights so that prediction errors for minority groups are weighted more heavily than prediction errors for majority groups.</p>
<!-- not sure that you need to raise the issue about problems with traditional ML for peronalized models.   its a tangent. Instead, just talk about using state-space modeling for peronalized models as a possible solution to address faireness-->
<p>Lastly, we could consider building models for a specific individual (i.e., idiographic) <span class="citation" data-cites="fisherOpenTrialPersonalized2019 wrightAppliedAmbulatoryAssessment2019">(<a href="#ref-fisherOpenTrialPersonalized2019" role="doc-biblioref">Fisher et al. 2019</a>; <a href="#ref-wrightAppliedAmbulatoryAssessment2019" role="doc-biblioref">Wright and Zimmermann 2019</a>)</span>. Person-specific models consider the characteristics and behaviors important to an individual rather than generalizing across a population. Unfortunately, a person-specific lapse prediction model requires a sufficient number of positive labels (i.e., lapses) for that individual. Waiting until an individual has lapsed multiple (perhaps many) times to offer help is in direct opposition with our goals. One potential solution to this conundrum may involve departing from traditional machine learning algorithms. For example, state space models, which are grounded in traditional repeated measures designs, inherently capture time series data and allow for the modeling of how an individual’s risk evolves over time from observable and latent states. <!--cite Erick's paper--></p>
<!--I dont think this issue is best though of as measurement bias.  That means something different.  I think you just need to describe the problem without needed a label for it-->
<p>Although representation in our data is likely a contributing factor, it is not the only factor affecting model fairness. We had equal representation of men and women, and we still saw differences in performance. This difference is likely due to another source of bias - measurement bias. We chose our EMA items based on domain expertise and years of relapse risk research. It is possible that these constructs more precisely describe relapse risk factors for men than for women. This could mean that more research is needed to identify relapse risk factors for women (and other groups underrepresented in the literature more broadly). Additionally, data driven (bottom-up) approaches to creating features could be one way to remove some of the bias in domain driven (top-down) approaches. For example, using natural language processing on text message content could allow for new categories of features to emerge.</p>
</section>
<section id="additional-limitations-and-future-directions" class="level2">
<h2>Additional Limitations and Future Directions</h2>
<!-- these ideas seem a bit to specific, narrow.  You need to think of the key large issues that need to be addressed.   I think burden is worthwhile.   How to use the models?   If you have those two first, the idea of geoplocation might adddress both burden and more, broader set of features?  Not sure what you mean in the last paragraph about preferences and perceptions.  And does that belong in the fairness section?-->
<!-- dont need to refer back to fairness future work here.  I think you need more context for why we want to do geolocation and text message (and maybe focus mostly on geolocation?)-->
<p>All of the proposed suggestions above for improving model fairness are current directions in our lab. In our current sample of participants, we are building models that prioritize accuracy for underrepresented groups. We are also building models that use other sensing methods, like geolocation and text message content, separately and in conjunction with EMA. In these combined models, we plan to assess whether the relative top features differs by demographic group. For example, it is possible that data-driven features (e.g., from geolocation) emerge as more important for groups that have been historically underrepresented in the research on relapse risk factors driving our self-report measures. To increase the diversity of our data, we recruited a nationally representative sample of people with opioid use disorder (data collection is near complete) <span class="citation" data-cites="moshontzProspectivePredictionLapses2021">(<a href="#ref-moshontzProspectivePredictionLapses2021" role="doc-biblioref">Moshontz et al. 2021</a>)</span>.</p>
<p>Measurement burden of EMA is also a concern. Research suggests people can comply with effortful sensing methods (e.g., 4x daily EMA) while using substances <span class="citation" data-cites="wyantAcceptabilityPersonalSensing2023 jonesComplianceEcologicalMomentary2019a">(<a href="#ref-wyantAcceptabilityPersonalSensing2023" role="doc-biblioref">Wyant et al. 2023</a>; <a href="#ref-jonesComplianceEcologicalMomentary2019a" role="doc-biblioref">Jones et al. 2019</a>)</span>. However, it is likely that frequent daily surveys will eventually become too burdensome when considering long-term monitoring. We plan to build models that use only 1x daily EMA to evaluate the trade-off between model performance and assessment burden. We also plan to build models that combine EMA and passive sensing methods, like geolocation, and evaluate the important features. It is possible that adding other low burden sensing methods could allow us to reduce the frequency (e.g., 1x weekly EMA) and/or length (e.g, 2-3 items) of our EMAs.</p>
<p>Finally, to address disparities in substance use treatment initiation and outcomes among underrepresented groups, it is important to solicit and consider individual preferences and perceptions of the sensing data used to build an algorithm-guided risk monitoring support system from the beginning (i.e., <em>before</em> an intervention is developed). Providing a support tool only acceptable to a majority group could widen existing disparities. To this end, we are currently using a mixed-methods design to assess issues related to feasibility and acceptability by sensing method and demographic characteristics in our national sample of participants with opioid use disorder.</p>
</section>
<section id="conclusion" class="level2">
<h2>Conclusion</h2>
<p>This study suggests it is possible to predict alcohol lapses up to two weeks into the future. This advanced notice could allow patients to implement multimodal support options not immediately available. Important steps are still needed to make these models clinically implementable. Most notably, is the increased fairness in model performance. However, we remain optimistic as we have already begun to take several steps in addressing these barriers.</p>
</section>
<section id="references" class="level2">
<h2>References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-baeMobilePhoneSensors2018" class="csl-entry" role="listitem">
Bae, Sangwon, Tammy Chung, Denzil Ferreira, Anind K. Dey, and Brian Suffoletto. 2018. <span>“Mobile Phone Sensors and Supervised Machine Learning to Identify Alcohol Use Events in Young Adults: <span>Implications</span> for Just-in-Time Adaptive Interventions.”</span> <em>Addictive Behaviors</em> 83 (August): 42–47. <a href="https://doi.org/10.1016/j.addbeh.2017.11.039">https://doi.org/10.1016/j.addbeh.2017.11.039</a>.
</div>
<div id="ref-chtc" class="csl-entry" role="listitem">
Center for High Throughput Computing. 2006. <span>“Center for High Throughput Computing.”</span> Center for High Throughput Computing. <a href="https://doi.org/10.21231/GNT1-HW21">https://doi.org/10.21231/GNT1-HW21</a>.
</div>
<div id="ref-chihPredictiveModelingAddiction2014" class="csl-entry" role="listitem">
Chih, Ming-Yuan, Timothy Patton, Fiona M. McTavish, Andrew J. Isham, Chris L. Judkins-Fisher, Amy K. Atwood, and David H. Gustafson. 2014. <span>“Predictive Modeling of Addiction Lapses in a Mobile Health Application.”</span> <em>Journal of Substance Abuse Treatment</em> 46 (1): 29–35. <a href="https://doi.org/10.1016/j.jsat.2013.08.004">https://doi.org/10.1016/j.jsat.2013.08.004</a>.
</div>
<div id="ref-derubeisHistoryCurrentStatus2019" class="csl-entry" role="listitem">
DeRubeis, Robert J. 2019. <span>“The History, Current Status, and Possible Future of Precision Mental Health.”</span> <em>Behaviour Research and Therapy</em> 123 (December): 103506. <a href="https://doi.org/10.1016/j.brat.2019.103506">https://doi.org/10.1016/j.brat.2019.103506</a>.
</div>
<div id="ref-fisherOpenTrialPersonalized2019" class="csl-entry" role="listitem">
Fisher, Aaron J., Hannah G. Bosley, Katya C. Fernandez, Jonathan W. Reeves, Peter D. Soyster, Allison E. Diamond, and Jonathan Barkin. 2019. <span>“Open Trial of a Personalized Modular Treatment for Mood and Anxiety.”</span> <em>Behaviour Research and Therapy</em> 116 (May): 69–79. <a href="https://doi.org/10.1016/j.brat.2019.01.010">https://doi.org/10.1016/j.brat.2019.01.010</a>.
</div>
<div id="ref-gabryPriorDistributionsRstanarm2023" class="csl-entry" role="listitem">
Gabry, Jonah, and Ben Goodrich. 2023. <span>“Prior <span>Distributions</span> for Rstanarm <span>Models</span>.”</span> <em>CRAN R-Project</em>. https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html.
</div>
<div id="ref-goodrichRstanarmBayesianApplied2023" class="csl-entry" role="listitem">
Goodrich, Ben, Jonah Gabry, Imad Ali, and Sam Brilleman. 2023. <span>“Rstanarm: <span>Bayesian Applied Regression Modeling</span> via <span>Stan</span>.”</span>
</div>
<div id="ref-greenfieldSubstanceAbuseTreatment2007" class="csl-entry" role="listitem">
Greenfield, Shelly F., Audrey J. Brooks, Susan M. Gordon, Carla A. Green, Frankie Kropp, R. Kathryn McHugh, Melissa Lincoln, Denise Hien, and Gloria M. Miele. 2007. <span>“Substance Abuse Treatment Entry, Retention, and Outcome in Women: <span>A</span> Review of the Literature.”</span> <em>Drug and Alcohol Dependence</em> 86 (1): 1–21. <a href="https://doi.org/10.1016/j.drugalcdep.2006.05.012">https://doi.org/10.1016/j.drugalcdep.2006.05.012</a>.
</div>
<div id="ref-hsiehSampleSizeTables1989" class="csl-entry" role="listitem">
Hsieh, F. 1989. <span>“Sample Size Tables for Logistic Regression.”</span> <em>Statistics in Medicine</em> 8: 795–802.
</div>
<div id="ref-jonesComplianceEcologicalMomentary2019a" class="csl-entry" role="listitem">
Jones, Andrew, Danielle Remmerswaal, Ilse Verveer, Eric Robinson, Ingmar H. A. Franken, Cheng K. Fred Wen, and Matt Field. 2019. <span>“Compliance with Ecological Momentary Assessment Protocols in Substance Users: A Meta-Analysis.”</span> <em>Addiction (Abingdon, England)</em> 114 (4): 609–19. <a href="https://doi.org/gfsjzg">https://doi.org/gfsjzg</a>.
</div>
<div id="ref-kilaruIncidenceTreatmentOpioid2020" class="csl-entry" role="listitem">
Kilaru, Austin S., Aria Xiong, Margaret Lowenstein, Zachary F. Meisel, Jeanmarie Perrone, Utsha Khatri, Nandita Mitra, and M. Kit Delgado. 2020. <span>“Incidence of <span>Treatment</span> for <span>Opioid Use Disorder Following Nonfatal Overdose</span> in <span>Commercially Insured Patients</span>.”</span> <em>JAMA Network Open</em> 3 (5): e205852. <a href="https://doi.org/10.1001/jamanetworkopen.2020.5852">https://doi.org/10.1001/jamanetworkopen.2020.5852</a>.
</div>
<div id="ref-kuhnTidyposteriorBayesianAnalysis2022" class="csl-entry" role="listitem">
Kuhn, Max. 2022. <span>“Tidyposterior: <span>Bayesian Analysis</span> to <span>Compare Models</span> Using <span>Resampling Statistics</span>.”</span>
</div>
<div id="ref-kuhnAppliedPredictiveModeling2018" class="csl-entry" role="listitem">
Kuhn, Max, and Kjell Johnson. 2018. <em>Applied <span>Predictive Modeling</span></em>. 1st ed. 2013, Corr. 2nd printing 2018 edition. New York: Springer. <a href="https://doi.org/10.1007/978-1-4614-6849-3">https://doi.org/10.1007/978-1-4614-6849-3</a>.
</div>
<div id="ref-kuhnTidymodelsCollectionPackages2020" class="csl-entry" role="listitem">
Kuhn, Max, and Hadley Wickham. 2020. <span>“Tidymodels: A Collection of Packages for Modeling and Machine Learning Using Tidyverse Principles.”</span>
</div>
<div id="ref-kullSigmoidsHowObtain2017" class="csl-entry" role="listitem">
Kull, Meelis, Telmo M. Silva Filho, and Peter Flach. 2017. <span>“Beyond Sigmoids: <span>How</span> to Obtain Well-Calibrated Probabilities from Binary Classifiers with Beta Calibration.”</span> <em>Electronic Journal of Statistics</em> 11 (2): 5052–80. <a href="https://doi.org/10.1214/17-EJS1338SI">https://doi.org/10.1214/17-EJS1338SI</a>.
</div>
<div id="ref-lundbergUnifiedApproachInterpreting2017" class="csl-entry" role="listitem">
Lundberg, Scott M., and Su-In Lee. 2017. <span>“A Unified Approach to Interpreting Model Predictions.”</span> In <em>Proceedings of the 31st <span>International Conference</span> on <span>Neural Information Processing Systems</span></em>, 4768–77. <span>NIPS</span>’17. Red Hook, NY, USA: Curran Associates Inc.
</div>
<div id="ref-marlattRelapsePreventionMaintenance1985" class="csl-entry" role="listitem">
Marlatt, G. Alan, and Judith R. Gordon, eds. 1985. <em>Relapse <span>Prevention</span>: <span>Maintenance Strategies</span> in the <span>Treatment</span> of <span>Addictive Behaviors</span></em>. First edition. New York: The Guilford Press.
</div>
<div id="ref-mba2024FederalPoverty2024" class="csl-entry" role="listitem">
MBA, Tony Bartels, DVM. 2024. <span>“2024 <span>Federal Poverty Rates Published</span>: <span>Why</span> That Matters for Your Student Loans.”</span> <em>VIN Foundation</em>. https://vinfoundation.org/2024-federal-poverty-rates-published-why-that-matters-for-your-student-loans/.
</div>
<div id="ref-moshontzProspectivePredictionLapses2021" class="csl-entry" role="listitem">
Moshontz, Hannah, Alejandra J. Colmenares, Gaylen E. Fronk, Sarah J. Sant’Ana, Kendra Wyant, Susan E. Wanta, Adam Maus, David H. Gustafson Jr, Dhavan Shah, and John J. Curtin. 2021. <span>“Prospective <span>Prediction</span> of <span>Lapses</span> in <span>Opioid Use Disorder</span>: <span>Protocol</span> for a <span>Personal Sensing Study</span>.”</span> <em>JMIR Research Protocols</em> 10 (12): e29563. <a href="https://doi.org/10.2196/29563">https://doi.org/10.2196/29563</a>.
</div>
<div id="ref-olfsonHealthcareCoverageService2022" class="csl-entry" role="listitem">
Olfson, Mark, Christine Mauro, Melanie M. Wall, C. Jean Choi, Colleen L. Barry, and Ramin Mojtabai. 2022. <span>“Healthcare Coverage and Service Access for Low-Income Adults with Substance Use Disorders.”</span> <em>Journal of Substance Abuse Treatment</em> 137 (June): 108710. <a href="https://doi.org/10.1016/j.jsat.2021.108710">https://doi.org/10.1016/j.jsat.2021.108710</a>.
</div>
<div id="ref-pinedoCurrentReexaminationRacial2019" class="csl-entry" role="listitem">
Pinedo, Miguel. 2019. <span>“A Current Re-Examination of Racial/Ethnic Disparities in the Use of Substance Abuse Treatment: <span>Do</span> Disparities Persist?”</span> <em>Drug and Alcohol Dependence</em> 202 (September): 162–67. <a href="https://doi.org/10.1016/j.drugalcdep.2019.05.017">https://doi.org/10.1016/j.drugalcdep.2019.05.017</a>.
</div>
<div id="ref-projectmatchresearchgroupMatchingAlcoholismTreatments1997" class="csl-entry" role="listitem">
Project Match Research Group, U. S. 1997. <span>“Matching Alcoholism Treatments to Client Heterogeneity: <span>Project MATCH Posttreatment</span> Drinking Outcomes.”</span> <em>Journal of Studies on Alcohol</em> 58 (1): 7–29.
</div>
<div id="ref-rstudioteamRStudioIntegratedDevelopment2020" class="csl-entry" role="listitem">
RStudio Team. 2020. <span>“<span>RStudio</span>: <span>Integrated Development</span> for <span>R</span>.”</span> Boston, MA: RStudio, Inc.
</div>
<div id="ref-soysterPooledPersonspecificMachine2022" class="csl-entry" role="listitem">
Soyster, Peter D., Leighann Ashlock, and Aaron J. Fisher. 2022. <span>“Pooled and Person-Specific Machine Learning Models for Predicting Future Alcohol Consumption, Craving, and Wanting to Drink: <span>A</span> Demonstration of Parallel Utility.”</span> <em>Psychology of Addictive Behaviors: Journal of the Society of Psychologists in Addictive Behaviors</em> 36 (3): 296–306. <a href="https://doi.org/10.1037/adb0000666">https://doi.org/10.1037/adb0000666</a>.
</div>
<div id="ref-waltersUsingMachineLearning2021" class="csl-entry" role="listitem">
Walters, Scott T., Michael S. Businelle, Robert Suchting, Xiaoyin Li, Emily T. Hébert, and Eun-Young Mun. 2021. <span>“Using Machine Learning to Identify Predictors of Imminent Drinking and Create Tailored Messages for at-Risk Drinkers Experiencing Homelessness.”</span> <em>Journal of Substance Abuse Treatment</em> 127 (August): 108417. <a href="https://doi.org/10.1016/j.jsat.2021.108417">https://doi.org/10.1016/j.jsat.2021.108417</a>.
</div>
<div id="ref-witkiewitzRelapsePreventionAlcohol2004" class="csl-entry" role="listitem">
Witkiewitz, Katie, and G. Alan Marlatt. 2004. <span>“Relapse Prevention for Alcohol and Drug Problems: <span>That</span> Was Zen, This Is Tao.”</span> <em>American Psychologist</em> 59 (4): 224–35. <a href="https://doi.org/10.1037/0003-066X.59.4.224">https://doi.org/10.1037/0003-066X.59.4.224</a>.
</div>
<div id="ref-witkiewitzModelingComplexityPosttreatment2007" class="csl-entry" role="listitem">
———. 2007. <span>“Modeling the Complexity of Post-Treatment Drinking: <span>It</span>’s a Rocky Road to Relapse.”</span> <em>Clinical Psychology Review</em>, New <span>Approaches</span> to the <span>Study</span> of <span>Change</span> in <span>Cognitive Behavioral Therapies</span>, 27 (6): 724–38. <a href="https://doi.org/10.1016/j.cpr.2007.01.002">https://doi.org/10.1016/j.cpr.2007.01.002</a>.
</div>
<div id="ref-wrightAppliedAmbulatoryAssessment2019" class="csl-entry" role="listitem">
Wright, Aidan G. C., and Johannes Zimmermann. 2019. <span>“Applied <span>Ambulatory Assessment</span>: <span>Integrating Idiographic</span> and <span>Nomothetic Principles</span> of <span>Measurement</span>.”</span> <em>Psychological Assessment</em> 31 (12): 1467–80. <a href="https://doi.org/10.1037/pas0000685">https://doi.org/10.1037/pas0000685</a>.
</div>
<div id="ref-wyantAcceptabilityPersonalSensing2023" class="csl-entry" role="listitem">
Wyant, Kendra, Hannah Moshontz, Stephanie B. Ward, Gaylen E. Fronk, and John J. Curtin. 2023. <span>“Acceptability of <span>Personal Sensing Among People With Alcohol Use Disorder</span>: <span>Observational Study</span>.”</span> <em>JMIR mHealth and uHealth</em> 11 (1): e41833. <a href="https://doi.org/10.2196/41833">https://doi.org/10.2196/41833</a>.
</div>
<div id="ref-wyantMachineLearningModels2023" class="csl-entry" role="listitem">
Wyant, Kendra, Sarah June Kittleson Sant’Ana, Gaylen Fronk, and John J. Curtin. 2024. <span>“Machine Learning Models for Temporally Precise Lapse Prediction in Alcohol Use Disorder.”</span> <em>Psychopathology and Clinical Science</em>. <a href="https://doi.org/10.31234/osf.io/cgsf7">https://doi.org/10.31234/osf.io/cgsf7</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Priors were set as follows: residual standard deviation ~ normal(location=0, scale=exp(2)), intercept (after centering predictors) ~ normal(location=2.3, scale=1.3), the two coefficients for window width contrasts ~ normal (location=0, scale=2.69), and covariance ~ decov(regularization=1, concentration=1, shape=1, scale=1).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The poverty cutoff was defined from the 2024 federal poverty line for the 48 continguous United States. Participants at or below $1560 annual income were categorized as below poverty.<span class="citation" data-cites="mba2024FederalPoverty2024">(<a href="#ref-mba2024FederalPoverty2024" role="doc-biblioref">MBA 2024</a>)</span><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>For our fairness analyses, we altered our outer loop resampling method from 3 x 10 cross-validation to 6 x 5 cross-validation. This method still gave us 30 held out tests sets, but by splitting the data across fewer folds (i.e., 5 vs. 10) we were able to reduce the likelihood of the minority group being absent in any single fold.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Baseline models in our previous study yielded a median auROC of .895. These models inadvertently excluded income and employment as features. We reran models to include these features in the current study.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
     </main>
<!-- /main column -->  <script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content -->  <script>var lightboxQuarto = GLightbox({"openEffect":"zoom","selector":".lightbox","closeEffect":"zoom","loop":false,"descPosition":"bottom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script> 
  </body>
</html>